<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sealed Bid Auctions | Confidential NFT Marketplace</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fhevmjs@0.5.3/bundle/bundle.web.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --zama-yellow: #FFD700;
            --zama-dark: #0F0F0F;
            --zama-darker: #060606;
            --zama-gray: #1A1A1A;
            --zama-light-gray: #2A2A2A;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--zama-dark);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255, 215, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 215, 0, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .yellow-glow {
            position: fixed;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.15) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .yellow-glow-1 {
            top: -200px;
            left: -200px;
            animation: float 20s ease-in-out infinite;
        }

        .yellow-glow-2 {
            bottom: -200px;
            right: -200px;
            animation: float 25s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(100px, 100px); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            position: relative;
            z-index: 1;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 32px 0;
            border-bottom: 1px solid rgba(255, 215, 0, 0.1);
            margin-bottom: 80px;
        }

        .logo {
            font-size: 28px;
            font-weight: 900;
            color: var(--zama-yellow);
            letter-spacing: -1px;
            text-transform: uppercase;
        }

        .logo-dot {
            color: var(--zama-yellow);
            font-size: 36px;
            line-height: 0;
        }

        .nav-links {
            display: flex;
            gap: 48px;
            align-items: center;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 15px;
            font-weight: 600;
            transition: color 0.3s ease;
            position: relative;
        }

        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--zama-yellow);
            transition: width 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--zama-yellow);
        }

        .nav-links a:hover::after {
            width: 100%;
        }

        .connect-btn {
            background: var(--zama-yellow);
            color: var(--zama-dark);
            padding: 14px 32px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }

        .connect-btn.connected {
            background: var(--zama-gray);
            color: var(--zama-yellow);
            border: 2px solid var(--zama-yellow);
        }

        .hero {
            text-align: center;
            margin-bottom: 100px;
            animation: fadeInUp 0.8s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-size: 80px;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 24px;
            letter-spacing: -3px;
        }

        .hero-yellow {
            color: var(--zama-yellow);
            position: relative;
            display: inline-block;
        }

        .hero-yellow::before {
            content: '';
            position: absolute;
            bottom: 8px;
            left: 0;
            width: 100%;
            height: 20px;
            background: var(--zama-yellow);
            opacity: 0.2;
            z-index: -1;
        }

        .hero p {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.6);
            max-width: 700px;
            margin: 0 auto 48px;
            line-height: 1.7;
            font-weight: 400;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            color: var(--zama-yellow);
            margin-bottom: 32px;
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            background: var(--zama-yellow);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 100px;
            animation: fadeInUp 0.8s ease 0.2s backwards;
        }

        .info-card {
            background: var(--zama-gray);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 16px;
            padding: 40px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--zama-yellow);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .info-card:hover::before {
            transform: scaleX(1);
        }

        .info-card:hover {
            border-color: var(--zama-yellow);
            transform: translateY(-8px);
            background: var(--zama-light-gray);
        }

        .info-card-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            background: rgba(255, 215, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 215, 0, 0.2);
        }

        .info-card h3 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #fff;
        }

        .info-card p {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.7;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .section-header h2 {
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .section-header h2 span {
            color: var(--zama-yellow);
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            background: var(--zama-gray);
            padding: 6px;
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }

        .filter-tab {
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }

        .filter-tab.active {
            background: var(--zama-yellow);
            color: var(--zama-dark);
        }

        .auctions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 28px;
            margin-bottom: 100px;
        }

        .auction-card {
            background: var(--zama-gray);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            animation: fadeInUp 0.6s ease backwards;
        }

        .auction-card:nth-child(1) { animation-delay: 0.1s; }
        .auction-card:nth-child(2) { animation-delay: 0.2s; }
        .auction-card:nth-child(3) { animation-delay: 0.3s; }

        .auction-card:hover {
            transform: translateY(-12px);
            border-color: var(--zama-yellow);
            box-shadow: 0 20px 60px rgba(255, 215, 0, 0.2);
        }

        .nft-image {
            height: 340px;
            background: var(--zama-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 140px;
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--zama-yellow);
        }

        .nft-image::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.2), transparent);
        }

        .auction-card:hover .nft-image::after {
            animation: shine 1.5s ease;
        }

        @keyframes shine {
            to {
                left: 100%;
            }
        }

        .auction-info {
            padding: 32px;
        }

        .auction-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 28px;
        }

        .auction-title {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .seller {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .status {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: rgba(255, 215, 0, 0.15);
            color: var(--zama-yellow);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .auction-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 28px;
            padding: 24px;
            background: var(--zama-dark);
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.1);
        }

        .stat {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
        }

        .stat-value {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--zama-yellow);
        }

        .bid-input {
            width: 100%;
            padding: 18px;
            background: var(--zama-dark);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .bid-input:focus {
            outline: none;
            border-color: var(--zama-yellow);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.1);
        }

        .bid-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .bid-btn {
            width: 100%;
            padding: 18px;
            background: var(--zama-yellow);
            border: none;
            border-radius: 10px;
            color: var(--zama-dark);
            font-size: 15px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .bid-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.5);
        }

        .bid-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .your-bids-section {
            background: var(--zama-gray);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 20px;
            padding: 48px;
            margin-bottom: 100px;
        }

        .your-bids-section h2 {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 36px;
            letter-spacing: -1px;
        }

        .your-bids-section h2 span {
            color: var(--zama-yellow);
        }

        .bid-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .bid-item {
            background: var(--zama-dark);
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-radius: 14px;
            padding: 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .bid-item:hover {
            border-color: var(--zama-yellow);
            background: var(--zama-darker);
        }

        .bid-item-left h4 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .encrypted-hash {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--zama-yellow);
            margin-bottom: 10px;
            opacity: 0.6;
        }

        .bid-timestamp {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.4);
            font-weight: 500;
        }

        .bid-amount {
            text-align: right;
        }

        .bid-amount-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--zama-yellow);
            margin-bottom: 4px;
            letter-spacing: -1px;
        }

        .bid-status {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: var(--zama-gray);
            border: 2px solid var(--zama-yellow);
            border-radius: 14px;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            min-width: 360px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(500px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-icon {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            flex-shrink: 0;
            background: rgba(255, 215, 0, 0.15);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--zama-yellow);
        }

        .toast-message {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 24px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 52px;
            }

            .info-cards, .auctions-grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="yellow-glow yellow-glow-1"></div>
    <div class="yellow-glow yellow-glow-2"></div>
    
    <div class="container">
        <!-- Credits -->
        <div style="text-align: center; padding: 20px 0; border-bottom: 1px solid rgba(255, 215, 0, 0.1); margin-bottom: 20px;">
            <p style="color: rgba(255, 255, 255, 0.6); font-size: 14px;">
                Developed by <a href="https://x.com/PurplethePlum" target="_blank" style="color: var(--zama-yellow); text-decoration: none; font-weight: 600;">Purple Plum</a>
            </p>
        </div>

        <nav>
            <div class="logo">
                SEALED<span class="logo-dot">.</span>
            </div>
            <div class="nav-links">
                <a href="#auctions">Auctions</a>
                <a href="#how-it-works">How It Works</a>
                <a href="#your-bids">Your Bids</a>
            </div>
            <button class="connect-btn" id="connectBtn">
                Connect Wallet
            </button>
        </nav>

        <!-- Diagnostic Info -->
        <div style="background: var(--zama-gray); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 40px;">
            <div style="font-size: 14px; font-weight: 600; color: var(--zama-yellow); margin-bottom: 12px;">üîß Debug Info</div>
            <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); font-family: 'Courier New', monospace; line-height: 1.8;">
                <div>MetaMask Installed: <span id="debugMetaMask">Checking...</span></div>
                <div>Ethers.js Loaded: <span id="debugEthers">Checking...</span></div>
                <div>fhevmjs Loaded: <span id="debugFhevm">Checking...</span></div>
                <div>Auction Address: <span style="color: var(--zama-yellow);">${AUCTION_ADDRESS.substring(0, 10)}...</span></div>
                <div>NFT Address: <span style="color: var(--zama-yellow);">${NFT_ADDRESS.substring(0, 10)}...</span></div>
            </div>
        </div>

        <div class="hero">
            <div class="badge">
                <div class="badge-dot"></div>
                Fully Homomorphic Encryption
            </div>
            <h1>
                Private NFT Auctions<br>
                <span class="hero-yellow">Fully Encrypted</span>
            </h1>
            <p>
                Place bids with complete confidence. Your bid amounts stay encrypted on-chain using Fully Homomorphic Encryption until the auction ends. No front-running, no manipulation.
            </p>
        </div>

        <div class="info-cards">
            <div class="info-card">
                <div class="info-card-icon">üîê</div>
                <h3>Fully Encrypted Bids</h3>
                <p>Every bid is encrypted using FHE technology. Not even blockchain validators can see your bid amount until reveal time.</p>
            </div>
            <div class="info-card">
                <div class="info-card-icon">‚öñÔ∏è</div>
                <h3>Fair & Transparent</h3>
                <p>Zero front-running. All bids remain sealed until auction concludes, ensuring a level playing field for everyone.</p>
            </div>
            <div class="info-card">
                <div class="info-card-icon">‚ö°</div>
                <h3>Instant Verification</h3>
                <p>Winner automatically determined through encrypted computation. Smart contracts handle everything trustlessly.</p>
            </div>
        </div>

        <div class="section-header" id="auctions">
            <h2>Live <span>Auctions</span></h2>
            <div class="filter-tabs">
                <button class="filter-tab active">All</button>
                <button class="filter-tab">Ending Soon</button>
                <button class="filter-tab">New</button>
            </div>
        </div>

        <div class="auctions-grid" id="auctionsGrid"></div>

        <div class="your-bids-section" id="your-bids">
            <h2>Your <span>Encrypted Bids</span></h2>
            <div class="bid-list" id="bidList">
                <div class="empty-state">
                    <div class="empty-state-icon">üîí</div>
                    <p>Connect your wallet to view your encrypted bids</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============ CONTRACT ADDRESSES ============
        const AUCTION_ADDRESS = '0xe789cF34071734CBCF0c7ff544f85649237cd7e9';
        const NFT_ADDRESS = '0x3a8Ad755BBf611419617099B67ED6767105EAA88';
        const SEPOLIA_CHAIN_ID = 11155111;
        const FHE_LIB_ADDRESS = '0x000000000000000000000000000000000000005d'; // FHEVM library address
        
        // ============ CONTRACT ABIs ============
        const AUCTION_ABI = [
            "function bid(bytes calldata encryptedBid, bytes calldata proof) external",
            "function getMyBid() external view returns (bytes32)",
            "function getMyTicket() external view returns (bytes32)",
            "function getBidderCount() external view returns (uint256)",
            "function hasEnded() external view returns (bool)",
            "function timeRemaining() external view returns (uint256)",
            "function getAuctionInfo() external view returns (address, uint256, address, uint256, uint256, uint256, bool, bool, bool, address)",
            "function getStatus() external view returns (string)",
            "function requestDecryption() external",
            "function amIWinner() external view returns (bool)",
            "function claimNFT() external",
            "function finalized() external view returns (bool)",
            "event BidPlaced(address indexed bidder, uint256 timestamp)"
        ];
        
        const NFT_ABI = [
            "function ownerOf(uint256 tokenId) external view returns (address)",
            "function tokenURI(uint256 tokenId) external view returns (string)"
        ];

        // ============ GLOBAL STATE ============
        let provider, signer, userAddress, userBids = {};
        let auctionContract = null;
        let fhevmInstance = null;

        const auctions = [
            {
                id: 1,
                name: 'Cosmic Dragon',
                number: '#4219',
                emoji: 'üêâ',
                seller: '0xDaC2...6547',
                endTime: Date.now() + 7200000,
                minBid: 0.01,
                contractAddress: AUCTION_ADDRESS,
                nftAddress: NFT_ADDRESS,
                tokenId: 0
            }
        ];

        // ============ FHE INSTANCE CREATION ============
        async function createFhevmInstance() {
            try {
                showToast('info', 'Initializing FHE', 'Fetching blockchain public key...');
                
                const network = await provider.getNetwork();
                const chainId = +network.chainId.toString();
                
                // Get FHE public key from blockchain
                const ret = await provider.call({
                    to: FHE_LIB_ADDRESS,
                    data: "0xd9d47bb001", // keccak256('fhePubKey(bytes1)') + 01
                });
                
                const decoded = ethers.AbiCoder.defaultAbiCoder().decode(["bytes"], ret);
                const publicKey = decoded[0];
                
                console.log('FHE Public Key retrieved:', publicKey.substring(0, 20) + '...');
                
                // Create fhevm instance
                fhevmInstance = await window.fhevm.createInstance({ chainId, publicKey });
                
                console.log('FHEVM instance created successfully');
                showToast('success', 'FHE Ready', 'Encryption system initialized');
                
                return fhevmInstance;
            } catch (error) {
                console.error('Error creating FHEVM instance:', error);
                showToast('error', 'FHE Error', 'Could not initialize encryption');
                throw error;
            }
        }

        // ============ WALLET CONNECTION ============
        async function connectWallet() {
            console.log('üîå connectWallet called!');
            
            try {
                // Check 1: MetaMask installed?
                console.log('üìç Checking MetaMask...');
                console.log('window.ethereum exists:', typeof window.ethereum !== 'undefined');
                console.log('window.ethereum:', window.ethereum);
                
                if (typeof window.ethereum === 'undefined') {
                    console.error('‚ùå MetaMask not found');
                    showToast('error', 'Wallet Required', 'Please install MetaMask to continue');
                    return;
                }

                console.log('‚úÖ MetaMask detected');
                console.log('üìû Requesting accounts...');
                
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                console.log('‚úÖ Accounts received:', accounts);
                console.log('Account count:', accounts.length);

                // Check if on Sepolia
                console.log('üåê Checking network...');
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const sepoliaChainId = '0xaa36a7';
                
                console.log('Current chainId:', chainId);
                console.log('Target chainId:', sepoliaChainId);
                console.log('Match:', chainId === sepoliaChainId);
                
                if (chainId !== sepoliaChainId) {
                    console.log('‚ö†Ô∏è Wrong network, switching...');
                    showToast('info', 'Wrong Network', 'Switching to Sepolia...');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: sepoliaChainId }],
                        });
                        console.log('‚úÖ Network switched');
                    } catch (switchError) {
                        console.error('Network switch error:', switchError);
                        if (switchError.code === 4902) {
                            console.log('üìù Network not added, adding Sepolia...');
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: sepoliaChainId,
                                        chainName: 'Sepolia Testnet',
                                        nativeCurrency: {
                                            name: 'ETH',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://sepolia.public.blastapi.io'],
                                        blockExplorerUrls: ['https://sepolia.etherscan.io']
                                    }]
                                });
                                console.log('‚úÖ Sepolia added');
                            } catch (addError) {
                                console.error('‚ùå Failed to add network:', addError);
                                showToast('error', 'Network Error', 'Please manually switch to Sepolia');
                                return;
                            }
                        } else {
                            console.error('‚ùå Switch failed:', switchError);
                            showToast('error', 'Network Switch Failed', 'Please manually switch to Sepolia');
                            return;
                        }
                    }
                }

                console.log('üîó Creating provider...');
                provider = new ethers.BrowserProvider(window.ethereum);
                console.log('Provider created:', provider);
                
                console.log('‚úçÔ∏è Getting signer...');
                signer = await provider.getSigner();
                console.log('Signer:', signer);
                
                userAddress = accounts[0];
                console.log('‚úÖ User address:', userAddress);

                // Connect to contract
                console.log('üìÑ Connecting to contract:', AUCTION_ADDRESS);
                auctionContract = new ethers.Contract(AUCTION_ADDRESS, AUCTION_ABI, signer);
                console.log('‚úÖ Contract connected');

                const btn = document.getElementById('connectBtn');
                btn.textContent = userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                btn.classList.add('connected');
                btn.disabled = true;

                showToast('success', 'Connected', 'Wallet connected successfully');
                
                // Initialize FHEVM
                console.log('üîê Initializing FHEVM...');
                try {
                    await createFhevmInstance();
                    console.log('‚úÖ FHEVM initialized');
                } catch (fheError) {
                    console.error('‚ö†Ô∏è FHEVM initialization failed:', fheError);
                    showToast('error', 'FHE Error', 'Could not initialize encryption. Bids may not work.');
                }
                
                // Load auction data
                console.log('üìä Loading auction data...');
                try {
                    await loadAuctionData();
                    console.log('‚úÖ Auction data loaded');
                } catch (loadError) {
                    console.error('‚ö†Ô∏è Failed to load auction data:', loadError);
                }
                
                renderAuctions();
                renderUserBids();
                
                showToast('success', 'Ready', 'You can now place encrypted bids');
                console.log('üéâ Wallet connection complete!');

            } catch (error) {
                console.error('üí• Connection error:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Full error:', JSON.stringify(error, null, 2));
                
                if (error.code === 4001) {
                    showToast('error', 'Rejected', 'Connection request was rejected');
                } else if (error.code === -32002) {
                    showToast('error', 'Pending', 'Connection request already pending. Check MetaMask.');
                } else {
                    showToast('error', 'Connection Failed', error.message || 'Could not connect to wallet');
                }
            }
        }

        // ============ LOAD AUCTION DATA ============
        async function loadAuctionData() {
            if (!auctionContract) return;
            
            try {
                const info = await auctionContract.getAuctionInfo();
                const status = await auctionContract.getStatus();
                const timeLeft = await auctionContract.timeRemaining();
                
                // Update auction data with real contract info
                auctions[0].endTime = Date.now() + (Number(timeLeft) * 1000);
                auctions[0].seller = info[2].substring(0, 6) + '...' + info[2].substring(38);
                auctions[0].minBid = Number(ethers.formatEther(info[4]));
                
                console.log('Auction Status:', status);
                console.log('Bidders:', Number(info[5]));
                console.log('Min Bid:', auctions[0].minBid);
            } catch (error) {
                console.error('Error loading auction:', error);
            }
        }

        // ============ RENDER AUCTIONS ============
        function renderAuctions() {
            const grid = document.getElementById('auctionsGrid');
            grid.innerHTML = '';

            auctions.forEach(auction => {
                const timeLeft = auction.endTime - Date.now();
                const hours = Math.floor(timeLeft / 3600000);
                const minutes = Math.floor((timeLeft % 3600000) / 60000);

                const card = document.createElement('div');
                card.className = 'auction-card';
                card.innerHTML = `
                    <div class="nft-image">${auction.emoji}</div>
                    <div class="auction-info">
                        <div class="auction-header">
                            <div>
                                <div class="auction-title">${auction.name}</div>
                                <div class="seller">${auction.seller}</div>
                            </div>
                            <div class="status">Live</div>
                        </div>
                        <div class="auction-stats">
                            <div class="stat">
                                <div class="stat-label">Min Bid</div>
                                <div class="stat-value">${auction.minBid} ETH</div>
                            </div>
                            <div class="stat">
                                <div class="stat-label">Ends In</div>
                                <div class="stat-value">${hours}h ${minutes}m</div>
                            </div>
                        </div>
                        <input 
                            type="number" 
                            class="bid-input" 
                            id="bid-${auction.id}"
                            placeholder="Enter bid amount"
                            step="0.01"
                            min="${auction.minBid}"
                            ${!userAddress ? 'disabled' : ''}
                        >
                        <button class="bid-btn" onclick="placeBid(${auction.id})" ${!userAddress ? 'disabled' : ''}>
                            Place Encrypted Bid
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // ============ PLACE BID ============
        async function placeBid(auctionId) {
            if (!auctionContract || !userAddress) {
                showToast('error', 'Not Connected', 'Please connect your wallet first');
                return;
            }

            if (!fhevmInstance) {
                showToast('error', 'FHE Not Ready', 'Encryption system not initialized');
                return;
            }

            const input = document.getElementById(`bid-${auctionId}`);
            const bidAmount = parseFloat(input.value);

            if (!bidAmount || bidAmount <= 0) {
                showToast('error', 'Invalid Bid', 'Please enter a valid amount');
                return;
            }

            const auction = auctions.find(a => a.id === auctionId);
            if (bidAmount < auction.minBid) {
                showToast('error', 'Bid Too Low', `Minimum bid is ${auction.minBid} ETH`);
                return;
            }

            try {
                showToast('info', 'Encrypting', 'Securing your bid with FHE...');
                
                // Convert ETH to Wei
                const bidInWei = ethers.parseEther(bidAmount.toString());
                const bidValue = BigInt(bidInWei.toString());
                
                console.log('Bid amount in Wei:', bidValue.toString());
                
                // Encrypt the bid using fhevmjs
                const encryptedBid = fhevmInstance.encrypt64(bidValue);
                
                console.log('Encrypted bid:', encryptedBid);
                
                showToast('info', 'Submitting', 'Sending encrypted bid to blockchain...');
                
                // Call contract with encrypted bid
                const tx = await auctionContract.bid(
                    '0x' + encryptedBid,
                    '0x' // Proof (handled by fhevmjs internally)
                );
                
                showToast('info', 'Confirming', 'Waiting for transaction confirmation...');
                
                const receipt = await tx.wait();
                
                if (!userBids[auctionId]) {
                    userBids[auctionId] = [];
                }
                
                const encrypted = btoa(bidAmount.toString() + userAddress);
                
                userBids[auctionId].push({
                    amount: bidAmount,
                    encrypted: encrypted,
                    timestamp: Date.now(),
                    auctionName: auction.name,
                    auctionNumber: auction.number,
                    txHash: receipt.hash
                });

                showToast('success', 'Bid Placed', 'Your encrypted bid is on-chain!');
                input.value = '';
                
                // Save to localStorage
                localStorage.setItem('userBids_' + userAddress, JSON.stringify(userBids));
                
                renderUserBids();
                await loadAuctionData();

            } catch (error) {
                console.error('Bid error:', error);
                if (error.code === 'ACTION_REJECTED') {
                    showToast('error', 'Rejected', 'Transaction was rejected');
                } else if (error.message && error.message.includes('Bid below minimum')) {
                    showToast('error', 'Bid Too Low', 'Your bid is below the minimum');
                } else {
                    showToast('error', 'Failed', error.message || 'Could not place bid');
                }
            }
        }

        // ============ RENDER USER BIDS ============
        function renderUserBids() {
            const container = document.getElementById('bidList');
            
            if (!userAddress) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîí</div>
                        <p>Connect your wallet to view your encrypted bids</p>
                    </div>
                `;
                return;
            }
            
            // Load from localStorage
            const saved = localStorage.getItem('userBids_' + userAddress);
            if (saved) {
                try {
                    userBids = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading bids:', e);
                }
            }

            if (Object.keys(userBids).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No bids yet. Start bidding on the auction above!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            
            Object.entries(userBids).forEach(([auctionId, bids]) => {
                bids.forEach((bid) => {
                    const item = document.createElement('div');
                    item.className = 'bid-item';
                    item.innerHTML = `
                        <div class="bid-item-left">
                            <h4>${bid.auctionName} ${bid.auctionNumber}</h4>
                            <div class="encrypted-hash">üîê ${bid.encrypted.substring(0, 32)}...</div>
                            <div class="bid-timestamp">${new Date(bid.timestamp).toLocaleString()}</div>
                            ${bid.txHash ? `<div class="bid-timestamp">TX: ${bid.txHash.substring(0, 10)}...</div>` : ''}
                        </div>
                        <div class="bid-amount">
                            <div class="bid-amount-value">${bid.amount} ETH</div>
                            <div class="bid-status">Encrypted & Sealed</div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            });
        }

        // ============ SHOW TOAST ============
        function showToast(type, title, message) {
            const icons = {
                success: '‚úì',
                error: '‚úï',
                info: '‚Ñπ'
            };

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        // ============ INITIALIZATION ============
        // Initial render
        renderAuctions();

        // Bind connect button
        document.getElementById('connectBtn').addEventListener('click', function() {
            console.log('Connect button clicked!');
            connectWallet();
        });

        // Auto-refresh auction times
        setInterval(() => {
            if (auctions.length > 0) renderAuctions();
        }, 60000);

        // Smooth scrolling for anchor links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Log when script is loaded
        console.log('Script loaded successfully');
        console.log('Auction Address:', AUCTION_ADDRESS);
        console.log('NFT Address:', NFT_ADDRESS);
        console.log('fhevmjs available:', typeof window.fhevm !== 'undefined');
    </script>
</body>
</html>
